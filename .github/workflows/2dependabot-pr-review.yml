name: new-dependabot-Auto-approve Dependabot PRs if bot has no comments

on:
  workflow_dispatch:
  # Optional: run on a schedule
  # schedule:
  #   - cron: '0 8 * * *'
  pull_request:
    branches: [ "main" ]

jobs:
  auto-approve-dependabot:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for gh pr merge
      pull-requests: write # Needed for gh pr review
      
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        env:
          token: ${{ env.ACCESS_TOKEN }}
        
      - name: Install GitHub CLI
        run: |  
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Process Dependabot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
        run: |
          REPO_OWNER=$(gh repo view --json owner -q '.owner.login')
          REPO_NAME=$(gh repo view --json name -q '.name')

          echo "Searching for open Dependabot PRs in $REPO_OWNER/$REPO_NAME..."
          echo "Filtering for PRs that have exactly zero comments total, then approving/merging..."

          PR_NUMBERS=$(gh pr list --state open --search "author:app/dependabot" --json number -q '.[].number')

          if [ -z "$PR_NUMBERS" ]; then
            echo "No open Dependabot PRs found."
            exit 0
          fi

          PROCESSED_PRS=()

          for PR_NUM in $PR_NUMBERS; do
            # Fetch all comments for the PR and count the total number
            COMMENTS_COUNT=$(gh api /repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUM/comments \
              --jq 'length')

            if [ "$COMMENTS_COUNT" -eq 0 ]; then
              PR_TITLE=$(gh pr view $PR_NUM --json title -q '.title')
              echo "  --> Action on PR #$PR_NUM: $PR_TITLE"
              echo "  This PR has 0 comments. Approving and enabling auto-merge."

              # Approve the PR
              # gh pr review $PR_NUM --approve -b "Automatically approved and merged because no comments were found (from bot or users)."

              # Enable auto-merge (squash method used as example)
              # gh pr merge $PR_NUM --auto --squash || echo "  Warning: Could not enable auto-merge or merge PR #$PR_NUM. It might have conflicts or pending checks."
              
              PROCESSED_PRS+=($PR_NUM)

            else
              echo "  [SKIPPED] PR #$PR_NUM has $COMMENTS_COUNT comments. No action taken."
            fi
          done

          echo "----------------------------"
          if [ ${#PROCESSED_PRS[@]} -eq 0 ]; then
            echo "SUMMARY: No PRs were approved/merged."
          else
            echo "SUMMARY: Approved and set for auto-merge PRs: ${PROCESSED_PRS[@]}"
          fi
