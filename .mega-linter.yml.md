
# The default Terraform flavor includes linters like:
# 
# TERRAFORM_TFLINT
# TERRAFORM_TERRASCAN
# TERRAFORM_TERRAGRUNT
# TERRAFORM_TERRAFORM_FMT
# 



# .mega-linter.yml
# extends: default # means that your configuration inherits the default MegaLinter settings.


# Enable only Terraform linter and enable the Trivy linter:
ENABLE_LINTERS:
  - TERRAFORM_TFLINT
  # - REPOSITORY_TRIVY

# Optional: Customize Terraform linter behavior
TERRAFORM_TFLINT_CONFIG_FILE: .tflint.hcl

# Include only Terraform files
FILTER_REGEX_INCLUDE: .*\.tf$

# Exclude directories if needed
EXCLUDED_DIRECTORIES:
  #- .github

# Reporting options
REPORTERS:
  - markdown
  - json
  - sarif
  - table
# Optional: Disable errors to avoid failing the pipeline
DISABLE_ERRORS: false
FLAVOR_SUGGESTIONS: false # creates more noise in the pr comment with additional info about megalinter flavors of terraform scans





#######################-------------------#######################
# Test trivy below
#This config tells MegaLinter to:
#Run Trivy with vulnerability, misconfiguration, and secret detection
#Only report high and critical issues
#Use a custom config file if needed

#REPOSITORY_TRIVY_CONFIG_FILE: trivy.yaml
# REPOSITORY_TRIVY_ARGUMENTS: "--severity HIGH,CRITICAL --ignore-unfixed"
# REPOSITORY_TRIVY_ARGUMENTS: "--scanners vuln,misconfig,secret --severity HIGH,CRITICAL"
# REPOSITORY_TRIVY_DISABLE_ERRORS: false

# To ensure Trivy only scans Terraform files, configure the file extensions and regex filters:
# REPOSITORY_TRIVY_FILE_EXTENSIONS:
#   - "tf"
# REPOSITORY_TRIVY_FILE_NAMES_REGEX: []
# FILTER_REGEX_INCLUDE: ".*\\.tf$"


# Use REPOSITORY_TRIVY_ARGUMENTS to pass custom flags to Trivy. For Terraform, use the config scan type and specify severity levels, output format, and scanners:
# REPOSITORY_TRIVY_ARGUMENTS: >
#   config
#   --scanners config,secret
#   --severity HIGH,CRITICAL,MEDIUM,LOW
#   --format table
#   --exit-code 1
#   --skip-dirs .terraform

# You can also specify a custom Trivy config file:
# REPOSITORY_TRIVY_CONFIG_FILE: "trivy.yaml"


# Create a trivy.yaml Config File
# This file allows more granular control over Trivy’s behavior:

# timeout: 5m0s
# exit-code: 1
# format: "table"
# output: "./trivy-report.txt"
# report: "all"
# misconfiguration:
#   scanners:
#     - terraform
# terraform:
#   vars:
#     - "./terraform/dev.tfvars"
#     - "./terraform/common.tfvars"
# scan:
#   scanners:
#     - secret
#     - misconfig


# Other Linters
# To avoid scanning non-Terraform files, disable unrelated linters:

# DISABLE_LINTERS:
#   - ALL
# ENABLE_LINTERS:
#   - REPOSITORY_TRIVY



github workflow:
name: MegaLinter Terraform Only

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  mega-linter:
    name: MegaLinter - Terraform with TFLint only
    runs-on: ubuntu-latest

    env:
      # Use the Terraform flavor as a base
      MEGALINTER_FLAVOR: terraform
      # Disable all linters first
      DISABLE_LINTERS: ALL
      # Enable only TFLint
      ENABLE_LINTERS: TERRAFORM_TFLINT
      # Optional: Only scan .tf files
      FILTER_REGEX_INCLUDE: '.*\\.tf$'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: MegaLinter
        uses: oxsecurity/megalinter@v7



or do this:
# Create a file at .github/workflows/mega-linter.yml in your repository with the following content:

name: MegaLinter test

on:
  pull_request:
    branches: [main]

env:
  APPLY_FIXES: none
  VALIDATE_ALL_CODEBASE: true

jobs:
  megalinter:
    name: MegaLinter job name
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: MegaLinter
        uses: oxsecurity/megalinter@v9.1.0
        id: ml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MEGALINTER_FLAVOR: terraform



MEGALINTER_FLAVOR: terraform: Starts with Terraform-focused linters.
DISABLE_LINTERS: ALL: Turns off all linters.
ENABLE_LINTERS: TERRAFORM_TFLINT: Enables only the tflint linter.
FILTER_REGEX_INCLUDE: Ensures only .tf files are scanned.



adding tryvy to this:

name: MegaLinter Terraform with TFLint and Trivy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  mega-linter:
    name: MegaLinter - Terraform with TFLint and Trivy
    runs-on: ubuntu-latest

    env:
      MEGALINTER_FLAVOR: terraform
      DISABLE_LINTERS: ALL
      ENABLE_LINTERS: |
        TERRAFORM_TFLINT
        REPOSITORY_TRIVY
      FILTER_REGEX_INCLUDE: '.*\\.tf$'
      REPOSITORY_TRIVY_FILE_EXTENSIONS: 'tf'
      REPOSITORY_TRIVY_ARGUMENTS: >
        config
        --scanners config,secret
        --severity HIGH,CRITICAL
        --format table
        --exit-code 1
        --skip-dirs .terraform

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: MegaLinter
        uses: oxsecurity/megalinter@v7



 Key Additions:

ENABLE_LINTERS: Now includes both TERRAFORM_TFLINT and REPOSITORY_TRIVY.
REPOSITORY_TRIVY_ARGUMENTS: Configures Trivy to scan for Terraform misconfigurations and secrets.
FILTER_REGEX_INCLUDE: Ensures only .tf files are scanned.



Then, in your GitHub Actions workflow, add a step to upload the report as an artifact:
- name: Upload Trivy Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.txt


If you want to persist Trivy’s output (e.g., for later review or uploading as an artifact), you can configure the output in your .mega-linter.yml or via environment variables:

REPOSITORY_TRIVY_ARGUMENTS: >
  config
  --scanners config,secret
  --severity HIGH,CRITICAL
  --format table
  --output trivy-report.txt
  --exit-code 1
  --skip-dirs .terraform


